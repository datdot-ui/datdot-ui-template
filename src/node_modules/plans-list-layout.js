const bel = require('bel')
const csjs = require('csjs-inject')
const path = require('path')
const filename = path.basename(__filename)
const layout = require('layout')
const button = require('datdot-ui-button')
const svg = require('datdot-ui-graphic')
window.Swiper = require('swiper').default

module.exports = plansList

function plansList ({page}, protocol) {
    const widget = 'ui-plans-list'
    let recipients = []
    const send2Parent = protocol( createNewPlanReceive )
    const content = myPlans()
    const section = layout({name: 'plans', className: `${css.plansList}`, content})
    send2Parent({page, from: 'plans-list', flow: widget, type: 'init', filename, line: 17})
    // return whole view
    // alert(screen.width)
    return section

    // create content
    function myPlans () {
        const iconCreate = svg({css: `${css.icon} ${css.create}`, path: 'assets/plus.svg'})
        const iconCryFace = svg({css: `${css.icon} ${css['cry-face']}`, path: 'assets/cry-face.svg'})
        const createPlan = button({page, name: 'create-plan', content: iconCreate, style: 'solid', color: 'dark', custom: [css['create-plan']]}, createNewPlanProtocol('create-plan'))
        const planList = createPlanItems()
        const swiperContainer = bel`<div class="${css['swiper-container']}"></div>`
        swiperContainer.append(planList)
        // display plan list
        document.addEventListener('DOMContentLoaded', ()=> {
            const mySwiper = new Swiper(`.${css['swiper-container']}`, {
                speed: 300,
                width: 250,
                slidesPerView: 2,
                slidesPerColumn: 2,
                spaceBetween: 4,
                breakpoints: {
                    
                },
                on: {
                    click: (event) => {
                    },
                    touchStart: (event) => {},
                    touchMove: (event) => {},
                    touchEnd: (event) => {
                        const swiperWrapper = event.wrapperEl
                        let currentMove = event.translate
                        lastMove = currentMove
                        return
                    }
                }
            })
        })

        const header = bel`
        <header>
            <div class=${css['header-top']}>
                <h1 class=${css.title}>My plans</h1>
                <div class=${css['plan-counts']}>No plan yet ${iconCryFace}</div>
            </div>
            <div id="plans-group" class=${css['plans-group']} role="plans group">
                ${createPlan}
                ${swiperContainer}
            </div>
        </header>`

        return header

        // create plan items
        function createPlanItems() {
            const planList = bel`<div class="swiper-wrapper ${css['plan-list']}"></div>`
            for (let i = 1; i < 25; i++) {
                const btn = button({page, name: `plan-${i}`, content: `Plan-${i}`, style: 'solid', color: 'white'}, btnProtocol(`plan-${i}`))
                const item = bel`<div index=${i} role="plan" class="swiper-slide ${css.plan}" aria-label="no plan">${btn}</div>`
                planList.append(item)
            }
            
            return planList
       }
    }

    function createNewPlanProtocol(name) {
        return send => {
            recipients[name] = send
            return createNewPlanReceive
        }
    }
    
    function createNewPlanReceive (message) {
        const { type } = message
        if (type === 'click') createPlanAction(message)
    }

    function createPlanAction (message) {
        const { page, from, flow, type, action, body, filename, line } = message
        recipients[from]({page, from: widget, type: 'disabled'})
        send2Parent({page, from, flow, type: 'create', filename, line: 61})
    }

    function btnProtocol (name) {
        return send => {
            return function receive (message) {
                console.log( message );
                send2Parent(message)
            }
        }
    }
}

const css = csjs`
.plansList {}
.header-top {
    display: grid;
    grid-template-rows: auto;
    grid-template-columns: repeat(2, 50%);
    align-items: flex-end;
    margin-bottom: 13px;
}
.title {
    font-size: 2.6rem;
}
.plan-counts {
    display: flex;
    font-size: 1.4rem;
    color: var(--grey70);
    justify-self: right;
}
.cry-face {
    width: 22px;
    margin-left: 10px;
}
.plans-group {
    position: relative;
    margin-right: -20px;
    height: 98px;
}
.create-plan {
    position: absolute;
    left: 0;
    top: 0;
    display: grid;
    justify-content: center;
    align-content: center;
    height: calc( 100% - 30px);
}
.icon {}
.create {
    width: 16px;
}
.plan-list {
    display: grid;
    grid-template-rows: repeat(2, 44px);
    grid-template-columns: repeat(24, minmax(auto, 138px) );
    grid-auto-flow: column;
    grid-gap: 2px 0;
}
.plan {
    max-width: 138px;
    height: 100%;
    background-color: var(--greyED); 
    border-radius: 8px;
    border: 1px dashed var(--grey88);
}
.swiper-container {
    width: calc(100% - 62px);
    height: 100%;
    max-width: 100%;
    margin-left: 62px;
    overflow: hidden;
}
.swiper-slide {}
@media and (max-width: 480px) {
    .plan-list {
        max-width: calc(138px * 12)
    }
}
`